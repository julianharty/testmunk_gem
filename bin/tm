#!/usr/bin/env ruby

require 'optparse'
require 'yaml'
# require 'testmunk/calabash/ios/utils/utils'
require_relative '../lib/testmunk/calabash/ios/utils/utils'

$stderr.sync = true

option = nil
app = nil
device = nil
feature_file = nil

# parse arguments
# tm -o install -f file.ipa

class YAMLConf
  attr_accessor :uuid, :endpoint, :bundle_id, :bundle_path

  class Device
    attr_accessor :uuid, :endpoint

    def initialize(config)
      @uuid = config['uuid']
      @endpoint = config['endpoint']
    end
  end

  def initialize(path)
    @config = YAML.load_file(path)

    @bundle_id = @config['run']['bundle_id']
    @bundle_path = @config['run']['bundle_path']
  end

  def device(device)
    Device.new(@config['run']['devices'][device])
  end
end

ARGV.options do |opts|
  opts.on('-a', '--app=val', '.ipa file', String) { |val| app = val }
  opts.on('-f', '--feature-file=val', '.feature file', String) { |val| feature_file = val }
  opts.on('-o', '--opt=val', 'Options: resign, install', String) { |val| option = val }
  opts.on('-d', '--device=val', 'Device', String) { |val| device = val }

  opts.on('-h', '--help', 'Displays Help') do
    puts opts
    exit
  end

  opts.parse!
end

case option
  when 'resign'
    Testmunk::IOS::Utils::resign(app, ENV['TM_MOBILE_PROVISION'],
                                 ENV['TM_WILDCARD'],
                                 ENV['TM_IOS_CERTIFICATE'],
                                 ENV['TM_BUNDLE_ID']) if app
  when 'install'
    Testmunk::IOS::Utils::install(app) if app
  when 'run'
    yaml = YAMLConf.new("#{Dir.pwd}/.tm.yaml")
    Testmunk::IOS::Utils::run(yaml.device(device).uuid,
                              yaml.device(device).endpoint,
                              yaml.bundle_id,
                              yaml.bundle_path, feature_file)
  when 'console'
    yaml = YAMLConf.new("#{Dir.pwd}/.tm.yaml")
    Testmunk::IOS::Utils::calabash_console(yaml.device(device).uuid,
                                           yaml.device(device).endpoint,
                                           yaml.bundle_id,
                                           yaml.bundle_path)
end